
<div class="toast-container" id="toastContainer"></div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip">
  <div class="tooltip-content"></div>
  <div class="tooltip-arrow"></div>
</div>

<!-- Welcome Modal -->
<div class="welcome-overlay" id="welcomeOverlay">
  <div class="welcome-card glass-panel">
    <h2>Welcome to Mockup Studio</h2>
    <p style="color: var(--text-secondary); margin: 8px 0 20px;">Create stunning device mockup videos in seconds</p>
    <div class="welcome-steps">
      <div class="step">
        <span class="step-icon"><i data-lucide="smartphone"></i></span>
        <span>Choose a device</span>
      </div>
      <div class="step">
        <span class="step-icon"><i data-lucide="video"></i></span>
        <span>Upload your video</span>
      </div>
      <div class="step">
        <span class="step-icon"><i data-lucide="sparkles"></i></span>
        <span>Export & share</span>
      </div>
    </div>
    <button class="btn btn-primary" id="dismissWelcome" style="width: 100%;">Get Started</button>
  </div>
</div>

<!-- Panel Backdrop for Mobile -->
<div class="panel-backdrop" id="panelBackdrop"></div>

<!-- Top Bar -->
<div class="top-bar">
  <!-- Mobile: Left Panel Toggle (Hamburger Menu) -->
  <button class="mobile-menu-toggle" id="mobileLeftToggle" title="Open menu">
    <i data-lucide="menu" style="width: 20px; height: 20px;"></i>
  </button>

  <span class="logo">Mockup Studio</span>

  <!-- Mobile: Right Panel Toggle -->
  <button class="mobile-menu-toggle" id="mobileRightToggle" title="Open effects" style="margin-left: auto;">
    <i data-lucide="sliders" style="width: 20px; height: 20px;"></i>
  </button>

  <div class="sep"></div>

  <label>Preset
    <select id="presetSelect">
      <option value="device">Device Only</option>
      <option value="reels" selected>Reels/TikTok (1080x1920)</option>
      <option value="twitter">Twitter/X (1080x1350)</option>
      <option value="youtube">YouTube (1920x1080)</option>
      <option value="square">Square (1080x1080)</option>
      <option value="custom">Custom</option>
    </select>
  </label>
  <span id="customSizeWrap" style="display:none">
    <input type="number" id="customW" value="1080" min="100" max="3840"> x
    <input type="number" id="customH" value="1920" min="100" max="3840">
  </span>

  <div class="sep"></div>

  <label>Entrance
    <select id="entranceSelect">
      <option value="none">None</option>
      <option value="fadeIn">Fade In</option>
      <option value="slideUp">Slide Up</option>
      <option value="scaleIn">Scale In</option>
      <option value="rotateIn">Rotate In</option>
    </select>
  </label>
  <label>Dur <input type="range" id="entranceDur" min="500" max="3000" value="1000" style="width:60px;accent-color:#60a5fa"> <span id="entranceDurVal">1.0s</span></label>

  <!-- Quick panel/tool shortcuts -->
  <div class="sep"></div>
  <button class="btn" id="addDeviceBtn" title="Device panel">
    <i data-lucide="smartphone"></i><span>Device</span>
  </button>
  <button class="btn" id="addAnnotationBtn" title="Annotations panel">
    <i data-lucide="pencil"></i><span>Annotate</span>
  </button>
  <button class="btn" id="showEffectsBtn" title="Effects panel">
    <i data-lucide="sliders"></i><span>Effects</span>
  </button>
  <button class="btn" id="showLayersBtn" title="Layers panel">
    <i data-lucide="layers"></i><span>Layers</span>
  </button>
  <button class="btn" id="showTimelineBtn" title="Timeline">
    <i data-lucide="clock"></i><span>Timeline</span>
  </button>

  <div class="spacer"></div>

  <button class="undo-btn" id="undoBtn" title="Undo (Ctrl+Z)" disabled><i data-lucide="rotate-ccw"></i></button>
  <button class="undo-btn" id="redoBtn" title="Redo (Ctrl+Shift+Z)" disabled><i data-lucide="rotate-cw"></i></button>
  <div class="sep"></div>

  <button class="btn" id="assetBrowserBtn" data-tooltip="Browse your asset library" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(168,85,247,0.2));border-color:rgba(139,92,246,0.3)"><i data-lucide="folder"></i><span>Assets</span></button>
  <button class="btn" id="themeToggleBtn" data-tooltip="Toggle light/dark theme"><i data-lucide="sun" id="themeToggleIcon"></i></button>
  <button class="btn" id="loadBtn" data-tooltip="Load a video file to get started"><i data-lucide="upload"></i><span>Load Video</span></button>
  <button class="btn" id="loopBtn" data-tooltip="Toggle video looping"><i data-lucide="repeat"></i><span>Loop</span></button>
  <button class="btn" id="ssBtn" data-tooltip="Save current frame as image"><i data-lucide="camera"></i><span>Screenshot</span></button>
  <button class="btn" id="thumbBtn" data-tooltip="Generate thumbnail from video"><i data-lucide="image"></i><span>Thumbnail</span></button>
  <button class="btn" id="kbHelpBtn" data-tooltip="View keyboard shortcuts" title="Keyboard shortcuts (?)"><i data-lucide="keyboard"></i></button>
  <button class="btn btn-primary" id="exportBtn" data-tooltip="Export your mockup as video"><i data-lucide="download"></i><span>Export</span></button>
</div>

<!-- Keyboard Shortcuts Overlay -->
<div class="kb-overlay" id="kbOverlay">
  <div class="kb-panel" style="position:relative">
    <button class="kb-close" id="kbClose">&times;</button>
    <h2>Keyboard Shortcuts</h2>
    <div class="kb-row"><span class="kb-key"><kbd>Space</kbd></span><span class="kb-action">Play / Pause</span></div>
    <div class="kb-row"><span class="kb-key"><kbd>‚Üê</kbd> <kbd>‚Üí</kbd></span><span class="kb-action">Seek ¬±5 seconds</span></div>
    <div class="kb-row"><span class="kb-key"><kbd>Ctrl</kbd><kbd>S</kbd></span><span class="kb-action">Save Screenshot</span></div>
    <div class="kb-row"><span class="kb-key"><kbd>Ctrl</kbd><kbd>Z</kbd></span><span class="kb-action">Undo</span></div>
    <div class="kb-row"><span class="kb-key"><kbd>Ctrl</kbd><kbd>‚áß</kbd><kbd>Z</kbd></span><span class="kb-action">Redo</span></div>
    <div class="kb-row"><span class="kb-key"><kbd>[</kbd> <kbd>]</kbd></span><span class="kb-action">Toggle sidebars</span></div>
    <div class="kb-row"><span class="kb-key"><kbd>?</kbd></span><span class="kb-action">Show this help</span></div>
    <div class="kb-tip">Tip: Press <kbd style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:4px;padding:1px 5px;font-size:9px;font-family:inherit;color:#666">?</kbd> anytime to see shortcuts</div>
  </div>
</div>

<!-- Export Dialog -->
<div class="export-dialog" id="exportDialog">
  <div class="export-dialog-panel">
    <div class="export-success" id="exportSuccess" style="display:none">
      <svg class="checkmark" viewBox="0 0 52 52">
        <circle class="checkmark-circle" cx="26" cy="26" r="25"/>
        <path class="checkmark-check" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
      </svg>
      <h3 style="color: var(--accent-success); margin-top: 12px;">Export Complete!</h3>
    </div>
    <h2>Export Settings</h2>
    <div class="ed-row"><label>Format</label><select id="edFormat"><option value="webm">WebM</option><option value="mp4">MP4 (H.264)</option></select></div>
    <div id="edFormatNote" style="font-size:9px;color:#666;padding:0 4px 4px;display:none"></div>
    <div class="ed-row"><label>Resolution</label>
      <select id="edResolution">
        <option value="original">Original</option>
        <option value="1080">1080p</option>
        <option value="720">720p</option>
      </select>
    </div>
    <div class="ed-row"><label>Quality</label>
      <select id="edQuality">
        <option value="5000000">Low (5 Mbps)</option>
        <option value="10000000" selected>Medium (10 Mbps)</option>
        <option value="20000000">High (20 Mbps)</option>
        <option value="40000000">Max (40 Mbps)</option>
      </select>
    </div>
    <div class="ed-row"><label>Framerate</label>
      <select id="edFramerate">
        <option value="24">24 fps</option>
        <option value="30" selected>30 fps</option>
        <option value="60">60 fps</option>
      </select>
    </div>
    <div class="ed-row"><label>Include Audio</label><input type="checkbox" id="edAudio" checked></div>
    <div class="ed-estimate" id="edEstimate"></div>
    <div class="ed-actions">
      <button class="btn" id="edCancel">Cancel</button>
      <button class="btn btn-primary" id="edStart">Start Export</button>
    </div>
  </div>
</div>

<!-- Main Layout -->
<div class="main-layout">

  <!-- Left Panel -->
  <div class="panel left-panel" id="leftPanel">
    <div class="panel-header">
      <h3 class="panel-title">Templates</h3>
      <button class="panel-toggle" id="leftPanelToggle" title="Toggle left panel [">¬´</button>
    </div>
    <div class="panel-body">
    <div class="panel-section">
      <div class="section-header">
        <h3>Studio Templates</h3>
        <button class="btn btn-danger" id="resetFullPresetBtn">Custom</button>
      </div>
      <div class="preset-grid" id="fullPresetGrid">
        <div class="preset-card" data-fp="appShowcase"><span class="pc-icon">üì±</span><span class="pc-name">App Showcase</span><span class="pc-desc">Cinematic device promo</span></div>
        <div class="preset-card" data-fp="tiktokViral"><span class="pc-icon">üî•</span><span class="pc-name">TikTok Viral</span><span class="pc-desc">Sunset vibes, trending</span></div>
        <div class="preset-card" data-fp="cleanProduct"><span class="pc-icon">‚ú®</span><span class="pc-name">Clean Product</span><span class="pc-desc">Minimal white showcase</span></div>
        <div class="preset-card" data-fp="darkCinematic"><span class="pc-icon">üé¨</span><span class="pc-name">Dark Cinema</span><span class="pc-desc">Moody film look</span></div>
        <div class="preset-card" data-fp="neonPop"><span class="pc-icon">üíú</span><span class="pc-name">Neon Pop</span><span class="pc-desc">Neon glow effects</span></div>
        <div class="preset-card" data-fp="cleanSocial"><span class="pc-icon">üì∏</span><span class="pc-name">Clean Social</span><span class="pc-desc">No device, video only</span></div>
        <div class="preset-card" data-fp="retroFilm"><span class="pc-icon">üéû</span><span class="pc-name">Retro Film</span><span class="pc-desc">Vintage film grain</span></div>
        <div class="preset-card" data-fp="laptopReview"><span class="pc-icon">üíª</span><span class="pc-name">Laptop Review</span><span class="pc-desc">MacBook ocean vibe</span></div>
        <div class="preset-card" data-fp="rawVideo"><span class="pc-icon">‚ñ∂Ô∏è</span><span class="pc-name">Raw Video</span><span class="pc-desc">No device, no effects</span></div>
        <div class="preset-card" data-fp="ipadPresent"><span class="pc-icon">üì≤</span><span class="pc-name">iPad Present</span><span class="pc-desc">iPad Pro minimal</span></div>
      </div>
    </div>

    <div class="panel-section" id="deviceSection">
      <div class="section-header">
        <h3>Device Frame</h3>
        <button class="collapse-toggle" id="deviceCollapseBtn">‚ñº</button>
      </div>
      <div class="collapsible-content" id="deviceContent">
        <div class="device-grid" id="deviceGrid">
          <div class="dev-btn" data-device="none"><span class="icon"><i data-lucide="x"></i></span>None</div>
          <div class="dev-btn active" data-device="iphone16"><span class="icon"><i data-lucide="smartphone"></i></span>iPhone 16</div>
          <div class="dev-btn" data-device="ipadpro"><span class="icon"><i data-lucide="tablet"></i></span>iPad Pro</div>
          <div class="dev-btn" data-device="macbookpro"><span class="icon"><i data-lucide="monitor"></i></span>MacBook</div>
          <div class="dev-btn" data-device="applewatch"><span class="icon"><i data-lucide="watch"></i></span>Watch</div>
        </div>
        <div id="colorSwatches" class="color-swatches"></div>
        <div class="toggle-row" id="deviceToggles">
          <button class="toggle-btn" id="landscapeBtn">Landscape</button>
          <button class="toggle-btn" id="comparisonBtn">Compare</button>
        </div>
        <div class="prop-row" style="margin-top:8px">
          <label>Quick Presets</label>
          <select id="devicePresetSelect" style="flex:1">
            <option value="">-- Choose Position --</option>
            <option value="phoneLeft">üì± Phone Left</option>
            <option value="phoneRight">üì± Phone Right</option>
            <option value="phoneCenterZoom">üîç Center Zoom</option>
            <option value="dualComparison">üì±üì± Dual Comparison</option>
            <option value="tilt3D">üé® 3D Tilt</option>
            <option value="landscapeView">üîÑ Landscape</option>
            <option value="floatingAbove">‚¨ÜÔ∏è Floating</option>
            <option value="bottomCorner">‚¨áÔ∏è Corner</option>
            <option value="laptopDesk">üíª Laptop</option>
            <option value="tabletPresenter">üìã Tablet</option>
          </select>
        </div>
      </div>
    </div>

    <div class="panel-section comparison-controls" id="comparisonControls">
      <div class="section-header">
        <h3>Device 2</h3>
        <button class="btn btn-danger" id="disableCompareBtn">Disable</button>
      </div>
      <div class="device-grid" id="device2Grid">
        <div class="dev-btn active" data-device="ipadpro"><span class="icon"><i data-lucide="tablet"></i></span>iPad Pro</div>
        <div class="dev-btn" data-device="iphone16"><span class="icon"><i data-lucide="smartphone"></i></span>iPhone 16</div>
        <div class="dev-btn" data-device="macbookpro"><span class="icon"><i data-lucide="monitor"></i></span>MacBook</div>
        <div class="dev-btn" data-device="applewatch"><span class="icon"><i data-lucide="watch"></i></span>Watch</div>
      </div>
      <div id="colorSwatches2" class="color-swatches"></div>
      <button class="btn" id="loadVideo2Btn" style="width:100%;margin-top:6px">Load Video for Device 2</button>
      <input type="file" id="video2Input" accept="video/*" style="display:none">
      <p id="video2Status" style="font-size:9px;color:#555;margin-top:4px">No video loaded for Device 2</p>
    </div>

    <div class="panel-section" id="deviceKeyframesSection" style="display:none">
      <h3>Device Animation</h3>
      <div style="display:flex;gap:4px;margin-bottom:8px">
        <button class="btn" id="addDeviceKeyframeBtn" style="flex:1">
          üìç Add Keyframe
        </button>
        <button class="btn" id="clearDeviceKeyframesBtn" style="flex:1;color:#f66">
          Clear All
        </button>
      </div>
      <div id="deviceKeyframesList" style="max-height:150px;overflow-y:auto">
        <!-- Keyframes will be listed here -->
      </div>
      <div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.4)">
        Keyframes: Position, Scale, Rotation, Perspective
      </div>
    </div>

    <div class="panel-section" id="standstillSection" style="display:none">
      <h3>Standstill Mode</h3>
      <select id="standstillModeSelect" style="width:100%;margin-bottom:8px">
        <option value="none">None (Normal Playback)</option>
        <option value="freezeDevice">Freeze Device, Loop Content</option>
        <option value="freezeBoth">Freeze Everything</option>
        <option value="pauseAnimation">Pause Animation Only</option>
      </select>
      <div id="freezeTimeControl" style="display:none;margin-top:8px">
        <label>Freeze At:</label>
        <input type="number" id="freezeTimeInput" min="0" step="0.1" value="0" style="width:80px">
        <button class="btn-sm" id="setFreezeTimeBtn">Use Current</button>
      </div>
      <div id="contentLoopControl" style="display:none;margin-top:8px">
        <label>Content Loop:</label>
        <input type="number" id="contentLoopStart" min="0" max="1" step="0.1" value="0" style="width:60px">
        <span>to</span>
        <input type="number" id="contentLoopEnd" min="0" max="1" step="0.1" value="1" style="width:60px">
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Layers</h3>
        <button class="btn btn-danger" id="clearLayersBtn">Clear</button>
      </div>
      <div class="unified-layers" id="unifiedLayers"></div>
      <div class="layer-actions">
        <button class="btn" id="quickAddText">+ Text</button>
        <button class="btn" id="quickAddLogo">+ Logo</button>
      </div>
      <div class="layer-detail" id="layerDetail" style="display:none"></div>
      <div style="margin-top:8px">
        <button class="btn" id="advLayerToggle" style="width:100%;font-size:8px;color:#555">Advanced Render Order</button>
        <div id="advLayerPanel" style="display:none;margin-top:6px">
          <div class="adv-label">Drag to reorder render groups</div>
          <div class="adv-stack" id="advStack"></div>
        </div>
      </div>
      <ul class="layer-list" id="layerList"></ul>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Hand Overlay</h3>
        <button class="btn btn-danger" id="resetHandBtn" style="display:none">Off</button>
      </div>
      <div class="toggle-row">
        <button class="toggle-btn" id="handBtn">Enable Hand</button>
        <select id="handStyle" style="background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#ccc;padding:2px 4px;font-size:10px">
          <option value="right">Right Hand</option>
          <option value="left">Left Hand</option>
        </select>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Scene Templates</h3>
        <button class="btn btn-danger" id="resetSceneBtn">Reset</button>
      </div>
      <div class="device-grid" id="sceneGrid">
        <div class="dev-btn active" data-scene="custom"><span class="icon">üé®</span>Custom</div>
        <div class="dev-btn" data-scene="floating"><span class="icon">üåå</span>Floating</div>
        <div class="dev-btn" data-scene="neon"><span class="icon">üíú</span>Neon Glow</div>
        <div class="dev-btn" data-scene="sunset"><span class="icon">üåÖ</span>Sunset</div>
        <div class="dev-btn" data-scene="minimal"><span class="icon">‚¨ú</span>Minimal</div>
        <div class="dev-btn" data-scene="ocean"><span class="icon">üåä</span>Ocean</div>
        <div class="dev-btn" data-scene="forest"><span class="icon">üå≤</span>Forest</div>
        <div class="dev-btn" data-scene="cinematic"><span class="icon">üé¨</span>Cinematic</div>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Animation Presets</h3>
        <button class="btn btn-danger" id="clearAnimPresetBtn">Stop</button>
      </div>
      <div class="device-grid" id="animPresetGrid">
        <div class="dev-btn active" data-anim="none"><span class="icon">‚èπ</span>None</div>
        <div class="dev-btn" data-anim="zoomBeat"><span class="icon">üéµ</span>Zoom Beat</div>
        <div class="dev-btn" data-anim="velocityEdit"><span class="icon">‚ö°</span>Velocity</div>
        <div class="dev-btn" data-anim="smoothSlide"><span class="icon">‚û°Ô∏è</span>Slide</div>
        <div class="dev-btn" data-anim="bounceIn"><span class="icon">üèÄ</span>Bounce</div>
        <div class="dev-btn" data-anim="glitch"><span class="icon">üì∫</span>Glitch</div>
        <div class="dev-btn" data-anim="cinematicPan"><span class="icon">üé•</span>Cine Pan</div>
        <div class="dev-btn" data-anim="shake"><span class="icon">üì≥</span>Shake</div>
      </div>
      <div class="prop-row" style="margin-top:8px"><label>Intensity</label><input type="range" id="animIntensity" min="10" max="200" value="100"></div>
      <div class="prop-row"><label>BPM</label><input type="range" id="animBPM" min="60" max="200" value="120"><span id="animBPMVal" style="font-size:9px;color:#666;min-width:30px">120</span></div>
      <div class="prop-row"><label>Auto BPM</label><button class="toggle-btn" id="autoBPMBtn" style="font-size:9px;padding:2px 8px">Off</button><span id="autoBPMStatus" style="font-size:8px;color:#555;margin-left:4px"></span></div>
      <div style="margin-top:6px">
        <button class="btn" id="importCapcutBtn" style="width:100%;font-size:9px">Import CapCut Draft</button>
        <input type="file" id="capcutFileInput" accept=".json,application/json" style="display:none">
        <p style="font-size:8px;color:#555;margin-top:3px">Upload draft_content.json from CapCut Desktop project folder</p>
      </div>
    </div>
    </div>
  </div>

  <!-- Canvas Stage -->
  <div class="stage" id="stage">
    <div class="canvas-wrap" id="canvasWrap">
      <canvas id="renderCanvas"></canvas>
      <div class="canvas-prompt visible" id="prompt">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        <p>Drop a screen recording here<br>or click to load</p>
        <p class="sub">MP4 / MOV / WebM</p>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="panel right-panel" id="rightPanel">
    <div class="panel-header">
      <h3 class="panel-title">Effects</h3>
      <button class="panel-toggle" id="rightPanelToggle" title="Toggle right panel ]">¬ª</button>
    </div>
    <div class="panel-body">
    <div class="panel-section">
      <div class="section-header">
        <h3>Background</h3>
        <button class="btn btn-danger" id="resetBgBtn">Reset</button>
      </div>
      <div class="prop-row">
        <label>Type</label>
        <select id="bgType">
          <option value="solid">Solid</option>
          <option value="gradient">Gradient</option>
          <option value="transparent">Transparent</option>
        </select>
      </div>
      <div id="bgSolidControls">
        <div class="prop-row"><label>Color</label><input type="color" id="bgColor" value="#0a0a0a"></div>
      </div>
      <div id="bgGradientControls" style="display:none">
        <div class="prop-row"><label>Color 1</label><input type="color" id="gradColor1" value="#0f0c29"></div>
        <div class="prop-row"><label>Color 2</label><input type="color" id="gradColor2" value="#302b63"></div>
        <div class="prop-row"><label>Color 3</label><input type="color" id="gradColor3" value="#24243e"></div>
        <div class="prop-row"><label>Angle</label><input type="range" id="gradAngle" min="0" max="360" value="135"></div>
        <div class="prop-row"><label>Animate</label>
          <select id="gradAnimated"><option value="false">Off</option><option value="true">On</option></select>
        </div>
      </div>
      <div class="prop-row"><label>Shadow</label><input type="range" id="shadowSlider" min="0" max="100" value="60"></div>
      <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px">
        <div class="section-header" style="margin-bottom:4px">
          <label style="font-size:9px;color:#666;font-weight:600">BG VIDEO</label>
          <button class="btn btn-danger" id="removeBgVideoBtn" style="display:none;padding:1px 6px;font-size:8px">Remove</button>
        </div>
        <button class="btn" id="loadBgVideoBtn" style="width:100%;font-size:9px">Load Background Video</button>
        <input type="file" id="bgVideoInput" accept="video/*" style="display:none">
        <p id="bgVideoStatus" style="font-size:8px;color:#555;margin-top:3px"></p>
        <div id="bgVideoControls" style="display:none">
          <div class="prop-row"><label>Opacity</label><input type="range" id="bgVideoOpacity" min="0" max="100" value="100"><span id="bgVideoOpacityVal" style="font-size:9px;color:#666;min-width:28px">100%</span></div>
          <div class="prop-row"><label>Fit</label>
            <select id="bgVideoFit">
              <option value="cover">Cover</option>
              <option value="contain">Contain</option>
              <option value="stretch">Stretch</option>
            </select>
          </div>
        </div>
      </div>
      <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px">
        <div class="section-header" style="margin-bottom:4px">
          <label style="font-size:9px;color:#666;font-weight:600">BG AUDIO</label>
        </div>
        <button class="btn" id="loadBgAudioBtn" style="width:100%;font-size:9px">Load Background Audio (MP3)</button>
        <input type="file" id="bgAudioInput" accept="audio/*" style="display:none">
        <p id="bgAudioStatus" style="font-size:8px;color:#555;margin-top:3px"></p>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Chroma Key (BG Remove)</h3>
        <button class="btn btn-danger" id="resetChromaBtn">Off</button>
      </div>
      <div class="prop-row"><label>Enable</label>
        <select id="chromaToggle"><option value="false">Off</option><option value="true">On</option></select>
      </div>
      <div id="chromaControls" style="display:none">
        <div class="prop-row"><label>Key Color</label><input type="color" id="chromaColor" value="#00ff00"></div>
        <div class="prop-row"><label>Tolerance</label><input type="range" id="chromaTolerance" min="10" max="200" value="80"></div>
        <div class="prop-row"><label>Softness</label><input type="range" id="chromaSoftness" min="0" max="80" value="10"></div>
        <p style="font-size:9px;color:#555;margin-top:4px">Pick the background color from your video to remove it. Works best with solid-color backgrounds.</p>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Effects</h3>
        <button class="btn btn-danger" id="resetEffectsBtn">Reset</button>
      </div>
      <div class="prop-row"><label>Particles</label>
        <select id="particleType">
          <option value="off">Off</option>
          <option value="bokeh">Bokeh</option>
          <option value="sparkle">Sparkle</option>
          <option value="confetti">Confetti</option>
          <option value="snow">Snow</option>
        </select>
      </div>
      <div class="prop-row"><label>Count</label><input type="range" id="particleCount" min="5" max="80" value="30"></div>
      <div class="prop-row"><label>Color</label><input type="color" id="particleColor" value="#ffffff"></div>
      <div class="prop-row"><label>Orbit</label>
        <select id="orbitToggle"><option value="false">Off</option><option value="true">On</option></select>
      </div>
      <div class="prop-row"><label>Speed</label><input type="range" id="orbitSpeed" min="5" max="100" value="30"></div>
      <div class="prop-row"><label>Blur</label>
        <select id="motionBlurToggle"><option value="false">Off</option><option value="true">On</option></select>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Overlays</h3>
        <button class="btn btn-danger" id="resetOverlaysBtn">Reset</button>
      </div>
      <div class="prop-row"><label>Progress</label>
        <select id="progressToggle"><option value="false">Off</option><option value="true">On</option></select>
        <input type="color" id="progressColor" value="#60a5fa">
      </div>
      <div class="prop-row"><label>Waveform</label>
        <select id="waveformToggle"><option value="false">Off</option><option value="true">On</option></select>
        <input type="color" id="waveformColor" value="#60a5fa">
      </div>
      <div class="prop-row"><label>Glass CTA</label>
        <select id="glassToggle"><option value="false">Off</option><option value="true">On</option></select>
      </div>
      <div id="glassControls" style="display:none">
        <div class="prop-row"><label>Text</label><input type="text" id="glassText" value="Your CTA Here"></div>
        <div class="prop-row"><label>Blur</label><input type="range" id="glassBlur" min="4" max="30" value="12"></div>
        <div class="prop-row"><label>Opacity</label><input type="range" id="glassOpacity" min="5" max="50" value="15"></div>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Video Overlays</h3>
        <button class="btn btn-danger" id="clearVideoOverlaysBtn">Clear</button>
      </div>
      <p style="font-size:8px;color:#555;margin-bottom:6px">Built-in effects (no files needed):</p>
      <div class="device-grid" id="builtinOverlayGrid" style="margin-bottom:8px">
        <div class="dev-btn" data-builtin="filmGrain">Film Grain</div>
        <div class="dev-btn" data-builtin="lightLeak">Light Leak</div>
        <div class="dev-btn" data-builtin="bokehLights">Bokeh</div>
        <div class="dev-btn" data-builtin="dust">Dust</div>
        <div class="dev-btn" data-builtin="vignette">Vignette</div>
        <div class="dev-btn" data-builtin="chromatic">Chromatic</div>
        <div class="dev-btn" data-builtin="scanlines">Scanlines</div>
        <div class="dev-btn" data-builtin="filmBurn">Film Burn</div>
      </div>
      <p style="font-size:8px;color:#555;margin-bottom:4px">Or load your own overlay videos:</p>
      <button class="btn" id="addVideoOverlayBtn" style="width:100%;margin-bottom:6px">+ Add Overlay Video</button>
      <input type="file" id="videoOverlayInput" accept="video/*" style="display:none" multiple>
      <div id="videoOverlayList"></div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Color Grading (LUT)</h3>
        <button class="btn btn-danger" id="clearLutBtn">Remove</button>
      </div>
      <p style="font-size:8px;color:#555;margin-bottom:6px">Quick presets:</p>
      <div class="device-grid" id="lutPresetGrid" style="margin-bottom:8px">
        <div class="dev-btn" data-lut-preset="none">None</div>
        <div class="dev-btn" data-lut-preset="cinematic">Cinematic</div>
        <div class="dev-btn" data-lut-preset="warmVintage">Warm Vintage</div>
        <div class="dev-btn" data-lut-preset="coolTeal">Cool Teal</div>
        <div class="dev-btn" data-lut-preset="bleachBypass">Bleach</div>
        <div class="dev-btn" data-lut-preset="moody">Moody</div>
        <div class="dev-btn" data-lut-preset="orangeTeal">Orange&Teal</div>
        <div class="dev-btn" data-lut-preset="bw">B&W Film</div>
      </div>
      <p style="font-size:8px;color:#555;margin-bottom:4px">Or load a .CUBE file:</p>
      <button class="btn" id="loadLutBtn" style="width:100%;margin-bottom:6px">Load .CUBE LUT</button>
      <input type="file" id="lutFileInput" accept=".cube,.CUBE" style="display:none">
      <div id="lutInfo" style="font-size:9px;color:#666;margin-top:4px"></div>
      <div id="lutControls" style="display:none">
        <div class="prop-row"><label>Intensity</label><input type="range" id="lutIntensity" min="0" max="100" value="100"><span id="lutIntensityVal" style="font-size:9px;color:#666;min-width:28px">100%</span></div>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Device Transform</h3>
        <button class="btn btn-danger" id="resetTransformBtn">Reset</button>
      </div>
      <div class="prop-row">
        <label>Scale</label>
        <input type="range" id="scaleSlider" min="15" max="100" value="45">
        <span id="scaleVal" style="font-size:10px;color:#777;min-width:28px">45%</span>
      </div>
      <div class="prop-row">
        <label>Fit</label>
        <select id="videoFitMode">
          <option value="cover">Cover</option>
          <option value="contain">Contain</option>
          <option value="stretch">Stretch</option>
        </select>
      </div>
      <div class="prop-row">
        <label>Tilt X</label>
        <input type="range" id="tiltX" min="-30" max="30" value="0">
      </div>
      <div class="prop-row">
        <label>Tilt Y</label>
        <input type="range" id="tiltY" min="-30" max="30" value="0">
      </div>
    </div>

    <div class="panel-section">
      <h3>Content</h3>
      <button class="btn" id="addTextBtn" style="width:100%;margin-bottom:6px">+ Add Text</button>
      <button class="btn" id="addLogoBtn" style="width:100%;margin-bottom:6px">+ Add Logo</button>
    </div>

    <div class="panel-section" id="textProps" style="display:none">
      <h3>Text Properties</h3>
      <div class="prop-row"><label>Text</label><input type="text" id="textContent" value="Title"></div>
      <div class="prop-row"><label>Font</label>
        <select id="textFont">
          <option value="SF Pro Display, -apple-system, sans-serif">SF Pro</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="Courier New, monospace">Courier</option>
          <option value="Impact, sans-serif">Impact</option>
          <option value="Arial, sans-serif">Arial</option>
        </select>
      </div>
      <div class="prop-row"><label>Size</label><input type="range" id="textSize" min="12" max="120" value="36"></div>
      <div class="prop-row"><label>Color</label><input type="color" id="textColor" value="#ffffff"></div>
      <div class="prop-row"><label>Weight</label>
        <select id="textWeight">
          <option value="400">Regular</option>
          <option value="600">Semi Bold</option>
          <option value="700" selected>Bold</option>
          <option value="900">Black</option>
        </select>
      </div>
      <div class="prop-row"><label>Shadow</label><input type="range" id="textShadow" min="0" max="20" value="0"></div>
      <div class="prop-row"><label>Outline</label><input type="range" id="textOutline" min="0" max="10" value="0"></div>
    </div>

    <div class="panel-section" id="logoProps" style="display:none">
      <h3>Logo Properties</h3>
      <div class="prop-row"><label>Opacity</label><input type="range" id="logoOpacity" min="0" max="100" value="100"></div>
      <div class="prop-row"><label>Width</label><input type="range" id="logoWidth" min="20" max="400" value="100"></div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Annotations</h3>
        <button class="btn btn-danger" id="clearAnnotationsBtn">Clear</button>
      </div>
      <div class="anno-toolbar" id="annoToolbar">
        <button class="anno-btn" data-tool="arrow">Arrow</button>
        <button class="anno-btn" data-tool="circle">Circle</button>
        <button class="anno-btn" data-tool="rect">Rect</button>
        <button class="anno-btn" data-tool="freehand">Draw</button>
        <button class="anno-btn" data-tool="callout">Callout</button>
      </div>
      <div class="prop-row"><label>Color</label><input type="color" id="annoColor" value="#ff4444"></div>
      <div class="prop-row"><label>Width</label><input type="range" id="annoWidth" min="1" max="10" value="3"></div>
      <div id="annoTimingControls" style="display:none;margin-top:6px;padding:6px 0;border-top:1px solid rgba(255,255,255,0.06)">
        <div style="font-size:9px;color:#666;margin-bottom:4px">Timing (selected annotation)</div>
        <div class="prop-row"><label>Start (s)</label><input type="number" id="annoStartTime" min="0" step="0.1" style="width:70px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#ccc;padding:3px 6px;font-size:11px"></div>
        <div class="prop-row"><label>End (s)</label><input type="number" id="annoEndTime" min="0" step="0.1" style="width:70px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#ccc;padding:3px 6px;font-size:11px"></div>
        <div class="prop-row"><label>Duration</label><span id="annoDuration" style="font-size:10px;color:#888">5.0s</span></div>
        <div class="prop-row"><label>Full video</label><input type="checkbox" id="annoFullVideo"></div>
      </div>
    </div>

    <div class="panel-section">
      <h3>Facecam</h3>
      <div style="display:flex;gap:4px;margin-bottom:6px">
        <button class="btn" id="facecamBtn" style="flex:1">Webcam</button>
        <button class="btn" id="facecamFileBtn" style="flex:1">Video File</button>
      </div>
      <input type="file" id="facecamFileInput" accept="video/*">
      <div id="facecamProps" style="display:none">
        <div class="prop-row"><label>Size</label><input type="range" id="facecamSize" min="5" max="35" value="15"><span id="facecamSizeVal" style="font-size:9px;color:#666;min-width:24px">15%</span></div>
        <div class="prop-row"><label>Shape</label>
          <select id="facecamShape">
            <option value="circle">Circle</option>
            <option value="roundrect">Rounded Rect</option>
            <option value="square">Square</option>
          </select>
        </div>
        <div class="prop-row"><label>Corner</label>
          <select id="facecamCorner">
            <option value="BR">Bottom Right</option>
            <option value="BL">Bottom Left</option>
            <option value="TR">Top Right</option>
            <option value="TL">Top Left</option>
            <option value="custom">Free Position</option>
          </select>
        </div>
        <div class="prop-row"><label>Border</label><input type="color" id="facecamBorderColor" value="#ffffff"><input type="range" id="facecamBorderWidth" min="0" max="8" value="3" style="flex:1"></div>
        <div class="prop-row"><label>Shadow</label>
          <select id="facecamShadow">
            <option value="true">On</option>
            <option value="false">Off</option>
          </select>
        </div>
        <button class="btn" id="facecamDisableBtn" style="width:100%;margin-top:4px;color:#f66;border-color:rgba(255,100,100,0.2)">Disable Facecam</button>
        <p style="font-size:9px;color:#555;margin-top:4px">Drag the facecam circle on the canvas to reposition</p>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-header">
        <h3>Zoom Keyframes</h3>
        <button class="btn btn-danger" id="clearKeyframesBtn">Clear</button>
      </div>
      <button class="btn" id="addKeyframeBtn" style="width:100%;margin-bottom:6px">+ Add Keyframe</button>
      <div class="prop-row"><label>Zoom</label><input type="range" id="kfZoom" min="100" max="300" value="100"></div>
      <div class="prop-row"><label>Pan X</label><input type="range" id="kfPanX" min="-200" max="200" value="0"></div>
      <div class="prop-row"><label>Pan Y</label><input type="range" id="kfPanY" min="-200" max="200" value="0"></div>
    </div>

    <div class="panel-section">
      <h3>Project</h3>
      <div style="display:flex;gap:4px;margin-bottom:6px">
        <button class="btn" id="saveProjectBtn" style="flex:1">Save Project</button>
        <button class="btn" id="loadProjectBtn" style="flex:1">Load Project</button>
      </div>
      <input type="file" id="projectFileInput" accept=".json,application/json" style="display:none">
      <button class="btn" id="resetAllBtn" style="width:100%;color:#f66;border-color:rgba(255,100,100,0.2)">Reset All</button>
    </div>
    </div>
  </div>
</div>

<!-- Enhanced Multi-Track Timeline System -->
<div class="timeline-system" id="timelineSystem">

  <!-- Background Audio Track -->
  <div class="bg-audio-track" id="bgAudioTrack">
    <div class="track-header" id="audioTrackHeader">
      <div class="track-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
      <div class="track-label">
        <span class="track-label-icon">üéµ</span>
        Background Audio
      </div>
      <div style="flex: 1"></div>
      <div class="track-actions">
        <button class="track-action-btn" id="bgAudioActionsBtn" title="Quick Actions" aria-label="Background audio quick actions" aria-expanded="false" aria-haspopup="true">‚ö°</button>
        <div class="track-actions-dropdown" id="bgAudioActionsDropdown" role="menu" aria-labelledby="bgAudioActionsBtn">
          <button onclick="applyBgAudioAction('fadeInAudio', 2000)">‚ÜóÔ∏è Fade In (2s)</button>
          <button onclick="applyBgAudioAction('fadeOutAudio', 2000)">‚ÜòÔ∏è Fade Out (2s)</button>
          <button onclick="applyBgAudioAction('fadeInSlow')">‚ÜóÔ∏è Fade In (5s)</button>
          <button onclick="applyBgAudioAction('fadeOutSlow')">‚ÜòÔ∏è Fade Out (5s)</button>
          <button onclick="applyBgAudioAction('ducking')">üîâ Ducking (30%)</button>
          <button onclick="applyBgAudioAction('loopBeat')">üîÑ Loop Beat</button>
          <button onclick="applyBgAudioAction('speedMatch')">‚ö° Speed Match</button>
          <button onclick="applyBgAudioAction('volumeBoost')">üîä Boost (100%)</button>
          <button onclick="applyBgAudioAction('bassBoost')">üé∏ Bass Boost</button>
          <button onclick="applyBgAudioAction('reverb')">üéµ Add Reverb</button>
          <button onclick="applyBgAudioAction('syncAudio')">üîó Sync to Main</button>
          <button onclick="applyBgAudioAction('resetAudio')">‚èÆÔ∏è Reset</button>
        </div>
      </div>
      <button class="track-loop-btn" id="audioLoopMarkerBtn" title="Loop Region" aria-label="Configure audio loop region" aria-expanded="false" aria-haspopup="true">üîÅ</button>
      <div class="track-loop-controls" id="audioLoopControls">
        <label style="font-size:10px">Loop Start:</label>
        <input type="number" id="audioLoopStart" min="0" max="1" step="0.1" value="0" style="width:60px">
        <label style="font-size:10px">End:</label>
        <input type="number" id="audioLoopEnd" min="0" max="1" step="0.1" value="1" style="width:60px">
        <button class="btn-sm" onclick="toggleAudioLoop()">Enable</button>
      </div>
      <button class="track-sync-btn" id="audioSyncBtn" title="Sync with main video">
        <span class="sync-icon">‚ö°</span> Sync
      </button>
      <button class="track-collapse-btn" id="audioCollapseBtn" title="Collapse/Expand track">‚ñº</button>
    </div>

    <div class="bg-track-content">
      <div class="bg-video-controls">
        <button class="track-play-btn" id="audioTrackPlayBtn" title="Play/Pause audio">
          <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="pause-icon" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="track-loop-btn" id="audioLoopBtn" title="Toggle loop">
          ‚Üª
        </button>
        <input type="range" id="audioVolumeSlider" min="0" max="100" value="100" title="Volume" style="width: 60px; margin: 0 4px;">
      </div>

      <div class="bg-progress-track" id="audioProgressTrack">
        <div class="bg-progress-fill" id="audioProgressFill" style="background: linear-gradient(90deg, rgba(245,158,11,0.3) 0%, rgba(245,158,11,0.2) 100%); border-right-color: rgba(245,158,11,0.8);">
          <div class="bg-progress-handle" style="background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 2px 8px rgba(245,158,11,0.4), 0 0 0 3px rgba(245,158,11,0.2);"></div>
          <div class="bg-progress-waveform"></div>
        </div>
      </div>

      <div class="bg-video-options">
        <span class="bg-time-display" id="audioTimeDisplay">0:00 / 0:00</span>
        <select class="track-speed-select" id="audioSpeedSelect">
          <option value="0.5">0.5√ó</option>
          <option value="0.75">0.75√ó</option>
          <option value="1" selected>1√ó</option>
          <option value="1.25">1.25√ó</option>
          <option value="1.5">1.5√ó</option>
          <option value="2">2√ó</option>
        </select>
        <button class="btn btn-danger" id="removeAudioBtn" style="padding: 4px 8px; font-size: 9px;">Remove</button>
      </div>

      <!-- Audio Effects Panel -->
      <div class="track-effects-section collapsed" id="bgAudioEffectsSection">
        <button class="effects-toggle-btn" id="bgAudioEffectsToggle">
          üéöÔ∏è Audio Effects
        </button>
        <div class="effects-panel">
          <!-- Mixing Section -->
          <div class="effect-group">
            <h4>Mixing</h4>
            <div class="effect-control">
              <label>Volume</label>
              <input type="range" id="bgAudioVolumeFX" min="0" max="200" value="100">
              <span class="value">100%</span>
            </div>
            <div class="effect-control">
              <label>Pan</label>
              <input type="range" id="bgAudioPan" min="-100" max="100" value="0">
              <span class="value">Center</span>
            </div>
            <button class="solo-btn" data-track="bgAudio">Solo</button>
            <button class="mute-btn" data-track="bgAudio">Mute</button>
          </div>

          <!-- EQ Section -->
          <div class="effect-group">
            <h4>Equalizer (3-Band)</h4>
            <canvas class="eq-graph" id="bgAudioEQGraph" width="200" height="80"></canvas>
            <div class="effect-control">
              <label>Low (200Hz)</label>
              <input type="range" id="bgAudioEQLow" min="-12" max="12" value="0" step="0.5">
              <span class="value">0 dB</span>
            </div>
            <div class="effect-control">
              <label>Mid (1kHz)</label>
              <input type="range" id="bgAudioEQMid" min="-12" max="12" value="0" step="0.5">
              <span class="value">0 dB</span>
            </div>
            <div class="effect-control">
              <label>High (3kHz)</label>
              <input type="range" id="bgAudioEQHigh" min="-12" max="12" value="0" step="0.5">
              <span class="value">0 dB</span>
            </div>
          </div>

          <!-- Compressor Section -->
          <div class="effect-group">
            <h4>Compressor</h4>
            <label>
              <input type="checkbox" id="bgAudioCompressorEnable">
              Enable
            </label>
            <div class="compressor-controls" id="bgAudioCompressorControls" style="display:none">
              <div class="effect-control">
                <label>Threshold</label>
                <input type="range" id="bgAudioCompThreshold" min="-60" max="0" value="-24">
                <span class="value">-24 dB</span>
              </div>
              <div class="effect-control">
                <label>Ratio</label>
                <select id="bgAudioCompRatio">
                  <option value="1.5">1.5:1</option>
                  <option value="3" selected>3:1</option>
                  <option value="8">8:1</option>
                  <option value="20">20:1 (Limiter)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Effects Section -->
          <div class="effect-group">
            <h4>Effects</h4>
            <label>
              <input type="checkbox" id="bgAudioReverbEnable">
              Reverb
            </label>
            <label>
              <input type="checkbox" id="bgAudioEchoEnable">
              Echo/Delay
            </label>
          </div>

          <!-- Presets -->
          <div class="effect-group">
            <h4>Presets</h4>
            <select id="bgAudioPreset">
              <option value="">-- Load Preset --</option>
              <option value="podcast">Podcast Voice</option>
              <option value="music">Music Enhancement</option>
              <option value="bass">Bass Boost</option>
              <option value="vocal">Vocal Clarity</option>
              <option value="radio">Radio Effect</option>
              <option value="spacious">Spacious Reverb</option>
            </select>
            <button class="save-preset-btn" id="bgAudioSavePreset">Save Custom</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Background Video Track -->
  <div class="bg-video-track" id="bgVideoTrack">
    <div class="track-header" id="bgVideoTrackHeader">
      <div class="track-indicator bg-video"></div>
      <div class="track-label">
        <span class="track-label-icon">üé¨</span>
        Background Video
      </div>
      <div style="flex: 1"></div>
      <div class="track-actions">
        <button class="track-action-btn" id="bgVideoActionsBtn" title="Quick Actions" aria-label="Background video quick actions" aria-expanded="false" aria-haspopup="true">‚ö°</button>
        <div class="track-actions-dropdown" id="bgVideoActionsDropdown" role="menu" aria-labelledby="bgVideoActionsBtn">
          <button onclick="applyBgVideoAction('fadeIn', 2000)">‚ÜóÔ∏è Fade In (2s)</button>
          <button onclick="applyBgVideoAction('fadeOut', 2000)">‚ÜòÔ∏è Fade Out (2s)</button>
          <button onclick="applyBgVideoAction('overlayMode')">üé® Overlay Mode (50%)</button>
          <button onclick="applyBgVideoAction('blurBackground')">üå´Ô∏è Blur Background</button>
          <button onclick="applyBgVideoAction('blackAndWhite')">‚ö´‚ö™ Black & White</button>
          <button onclick="applyBgVideoAction('splitScreen')">üì± Split Screen</button>
          <button onclick="applyBgVideoAction('resetFilters')">üîÑ Reset Filters</button>
          <button onclick="applyBgVideoAction('syncPerfect')">üîó Sync to Main</button>
          <button onclick="applyBgVideoAction('speedSlow')">üêå Slow (0.5x)</button>
          <button onclick="applyBgVideoAction('speedFast')">‚ö° Fast (2x)</button>
          <button onclick="applyBgVideoAction('enableLoop')">üîÑ Loop</button>
          <button onclick="applyBgVideoAction('resetToStart')">‚èÆÔ∏è Reset</button>
        </div>
      </div>
      <button class="track-loop-btn" id="videoLoopMarkerBtn" title="Loop Region" aria-label="Configure video loop region" aria-expanded="false" aria-haspopup="true">üîÅ</button>
      <div class="track-loop-controls" id="videoLoopControls">
        <label style="font-size:10px">Loop Start:</label>
        <input type="number" id="videoLoopStart" min="0" max="1" step="0.1" value="0" style="width:60px">
        <label style="font-size:10px">End:</label>
        <input type="number" id="videoLoopEnd" min="0" max="1" step="0.1" value="1" style="width:60px">
        <button class="btn-sm" onclick="toggleVideoLoop()">Enable</button>
      </div>
      <button class="track-sync-btn" id="bgSyncBtn" title="Sync with main video">
        <span class="sync-icon">‚ö°</span> Sync
      </button>
      <button class="track-collapse-btn" id="bgVideoCollapseBtn" title="Collapse/Expand track">‚ñº</button>
    </div>

    <div class="bg-track-content">
      <div class="bg-video-controls">
        <button class="track-play-btn" id="bgTrackPlayBtn" title="Play/Pause background video">
          <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg class="pause-icon" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="track-loop-btn" id="bgLoopBtn" title="Toggle loop">
          ‚Üª
        </button>
      </div>

      <div class="bg-progress-track" id="bgProgressTrack">
        <div class="bg-progress-fill" id="bgProgressFill">
          <div class="bg-progress-handle"></div>
          <div class="bg-progress-waveform"></div>
        </div>
      </div>

      <div class="bg-video-options">
        <span class="bg-time-display" id="bgTimeDisplay">0:00 / 0:00</span>
        <select class="track-speed-select" id="bgSpeedSelect">
          <option value="0.5">0.5√ó</option>
          <option value="0.75">0.75√ó</option>
          <option value="1" selected>1√ó</option>
          <option value="1.25">1.25√ó</option>
          <option value="1.5">1.5√ó</option>
          <option value="2">2√ó</option>
        </select>
      </div>

      <!-- Video Effects Panel -->
      <div class="track-effects-section collapsed" id="bgVideoEffectsSection">
        <button class="effects-toggle-btn" id="bgVideoEffectsToggle">
          ‚ú® Video Effects
        </button>
        <div class="effects-panel">
          <!-- Color Correction -->
          <div class="effect-group">
            <h4>Color Correction</h4>
            <div class="effect-control">
              <label>Brightness</label>
              <input type="range" id="bgVideoBrightness" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
            <div class="effect-control">
              <label>Contrast</label>
              <input type="range" id="bgVideoContrast" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
            <div class="effect-control">
              <label>Saturation</label>
              <input type="range" id="bgVideoSaturation" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
            <div class="effect-control">
              <label>Hue</label>
              <input type="range" id="bgVideoHue" min="-180" max="180" value="0">
              <span class="value">0¬∞</span>
            </div>
            <div class="effect-control">
              <label>Temperature</label>
              <input type="range" id="bgVideoTemp" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
          </div>

          <!-- Effect Stack -->
          <div class="effect-group">
            <h4>Effect Stack</h4>
            <div class="effect-stack" id="bgVideoEffectStack">
              <span style="font-size: 10px; color: #666;">No effects added</span>
            </div>
            <select id="bgVideoAddEffect">
              <option value="">+ Add Effect</option>
              <option value="blur">Blur</option>
              <option value="sharpen">Sharpen</option>
              <option value="pixelate">Pixelate</option>
              <option value="edgedetect">Edge Detect</option>
              <option value="posterize">Posterize</option>
              <option value="grayscale">Grayscale</option>
              <option value="sepia">Sepia</option>
            </select>
          </div>

          <!-- Blend Modes -->
          <div class="effect-group">
            <h4>Blend Mode</h4>
            <select id="bgVideoBlendMode">
              <option value="normal">Normal</option>
              <option value="multiply">Multiply</option>
              <option value="screen">Screen</option>
              <option value="overlay">Overlay</option>
              <option value="darken">Darken</option>
              <option value="lighten">Lighten</option>
            </select>
          </div>

          <!-- Presets -->
          <div class="effect-group">
            <h4>Presets</h4>
            <select id="bgVideoPreset">
              <option value="">-- Load Preset --</option>
              <option value="cinematic">Cinematic</option>
              <option value="vibrant">Vibrant Pop</option>
              <option value="vintage">Vintage Film</option>
              <option value="bwContrast">B&W Contrast</option>
              <option value="cool">Cool Tone</option>
              <option value="warm">Warm Tone</option>
              <option value="fade">Faded Look</option>
              <option value="dramatic">Dramatic</option>
            </select>
            <button class="save-preset-btn" id="bgVideoSavePreset">Save Custom</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Device Video Track -->
  <div class="main-video-track" id="mainVideoTrack">
    <div class="track-header" id="mainVideoTrackHeader">
      <div class="track-indicator"></div>
      <div class="track-label">
        <span class="track-label-icon">üì±</span>
        Device Content
      </div>
      <div style="flex: 1"></div>
      <button class="track-collapse-btn" id="mainVideoCollapseBtn" title="Collapse/Expand track">‚ñº</button>
    </div>

    <div class="main-track-content">
      <div style="min-width: 140px">
        <span id="mainVideoFileName" style="font-size: 10px; color: rgba(255,255,255,0.5); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
      </div>

      <!-- Timeline Track (existing multi-clip timeline) -->
      <div class="timeline-track" id="timelineTrack" style="height: 40px; margin: 0;">
        <div class="timeline-scrubber" id="timelineScrubber"></div>
      </div>

      <div style="display: flex; gap: 8px; align-items: center;">
        <button class="btn" id="addClipBtn" style="font-size: 9px; padding: 4px 8px;">+ Clip</button>
        <select id="transitionSelect" class="track-speed-select" style="min-width: 80px;">
          <option value="cut">Cut</option>
          <option value="crossfade">Crossfade</option>
          <option value="slide">Slide</option>
        </select>
      </div>

      <!-- Main Video Effects Panel -->
      <div class="track-effects-section collapsed" id="mainVideoEffectsSection">
        <button class="effects-toggle-btn" id="mainVideoEffectsToggle">
          ‚ú® Video Effects
        </button>
        <div class="effects-panel">
          <!-- Color Correction -->
          <div class="effect-group">
            <h4>Color Correction</h4>
            <div class="effect-control">
              <label>Brightness</label>
              <input type="range" id="mainVideoBrightness" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
            <div class="effect-control">
              <label>Contrast</label>
              <input type="range" id="mainVideoContrast" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
            <div class="effect-control">
              <label>Saturation</label>
              <input type="range" id="mainVideoSaturation" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
            <div class="effect-control">
              <label>Hue</label>
              <input type="range" id="mainVideoHue" min="-180" max="180" value="0">
              <span class="value">0¬∞</span>
            </div>
            <div class="effect-control">
              <label>Temperature</label>
              <input type="range" id="mainVideoTemp" min="-100" max="100" value="0">
              <span class="value">0</span>
            </div>
          </div>

          <!-- Effect Stack -->
          <div class="effect-group">
            <h4>Effect Stack</h4>
            <div class="effect-stack" id="mainVideoEffectStack">
              <span style="font-size: 10px; color: #666;">No effects added</span>
            </div>
            <select id="mainVideoAddEffect">
              <option value="">+ Add Effect</option>
              <option value="blur">Blur</option>
              <option value="sharpen">Sharpen</option>
              <option value="pixelate">Pixelate</option>
              <option value="edgedetect">Edge Detect</option>
              <option value="posterize">Posterize</option>
              <option value="grayscale">Grayscale</option>
              <option value="sepia">Sepia</option>
            </select>
          </div>

          <!-- Presets -->
          <div class="effect-group">
            <h4>Presets</h4>
            <select id="mainVideoPreset">
              <option value="">-- Load Preset --</option>
              <option value="cinematic">Cinematic</option>
              <option value="vibrant">Vibrant Pop</option>
              <option value="vintage">Vintage Film</option>
              <option value="bwContrast">B&W Contrast</option>
              <option value="cool">Cool Tone</option>
              <option value="warm">Warm Tone</option>
              <option value="fade">Faded Look</option>
              <option value="dramatic">Dramatic</option>
            </select>
            <button class="save-preset-btn" id="mainVideoSavePreset">Save Custom</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unified Playback Controls -->
  <div class="unified-controls">
    <button class="master-play-btn" id="masterPlayBtn" title="Play/Pause (Space)">
      <svg id="masterIconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="masterIconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>

    <div class="progress-track" id="progressTrack" style="flex: 1; margin: 0;">
      <div class="progress-fill" id="progressFill">
        <div class="progress-handle">
          <div class="progress-tooltip" id="progressTooltip"></div>
        </div>
      </div>
    </div>

    <span class="master-time-display" id="masterTimeDisplay">0:00 / 0:00</span>

    <select class="track-speed-select" id="speedSelect">
      <option value="0.25">0.25√ó</option>
      <option value="0.5">0.5√ó</option>
      <option value="1" selected>1√ó</option>
      <option value="1.5">1.5√ó</option>
      <option value="2">2√ó</option>
    </select>

    <div class="timeline-zoom-control">
      <button class="zoom-btn" id="zoomOutBtn" title="Zoom out timeline">‚àí</button>
      <button class="zoom-btn" id="zoomInBtn" title="Zoom in timeline">+</button>
    </div>
  </div>
</div>

<!-- Legacy elements for compatibility -->
<div class="timeline-bar" id="timelineBar" style="display:none"></div>
<div class="playback-bar" id="playbackBar" style="display:none">
  <button class="play-btn" id="playBtn">
    <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
  </button>
  <span class="time-label" id="timeLabel">0:00 / 0:00</span>
  <span id="videoFileName" style="font-size:10px;color:#666"></span>
</div>

<!-- Drop overlay -->
<div class="drop-overlay" id="dropOverlay">Drop video file</div>

<!-- Asset Browser Modal -->
<div class="asset-browser" id="assetBrowser">
  <div class="asset-browser-header">
    <h2>Asset Library</h2>
    <input type="text" class="ab-search" id="abSearch" placeholder="Search assets...">
    <div style="flex:1"></div>
    <span id="abStatus" style="font-size:9px;color:#555;white-space:nowrap"></span>
    <button class="ab-close" id="abClose">&times;</button>
  </div>
  <div class="asset-browser-body">
    <div class="ab-sidebar" id="abSidebar"></div>
    <div class="ab-content" id="abContent">
      <div class="ab-empty" id="abEmpty">
        <div style="font-size:40px">üìÇ</div>
        <div>Connect your asset folder</div>
        <p style="font-size:10px;color:#444;max-width:250px;text-align:center">Pick your Google Drive or local folder with LUTs, overlays, and video assets</p>
        <button class="btn btn-primary" id="abPickFolder">Choose Folder</button>
      </div>
    </div>
  </div>
</div>

<!-- Export status -->
<div class="export-status" id="exportStatus">
  <span id="exportText">Exporting...</span>
  <div class="bar"><div class="bar-fill" id="exportBarFill"></div></div>
</div>

<!-- Hidden elements -->
<input type="file" id="fileInput" accept="video/*">
<input type="file" id="logoInput" accept="image/*">
<input type="file" id="clipInput" accept="video/*">
<video id="srcVideo" style="display:none" playsinline></video>
<video id="srcVideo2" style="display:none" playsinline loop></video>
<video id="bgVideo" style="display:none" playsinline loop muted></video>
<audio id="bgAudio" style="display:none"></audio>
